<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سوق الحي</title>

  <!-- favicon (الشعار) -->
  <link rel="icon" href="./assets/logo.png" />

  <!-- Firebase SDKs (compat mode) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f5f6fa;
      --primary:#1e90ff;
      --muted:#9aa3b2;
      --text:#333333;
      --white:#ffffff;
      --card:#ffffff;
      --shadow: 0 4px 14px rgba(30,144,255,0.08);
      --golden-shadow: 0 6px 20px rgba(0,0,0,0.08);
      --gold:#A8742B;
    }
    html,body{height:100%;margin:0;font-family: "Segoe UI", Tahoma, Arial, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    /* loading screen */
    #splash {
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;flex-direction:column;
      transition:opacity .5s ease, visibility .5s;
    }
    #splash.hidden{opacity:0;visibility:hidden}
    #splash img{width:120px;height:120px;object-fit:contain;filter: drop-shadow(var(--golden-shadow))}
    #splash .title{margin-top:12px;font-size:20px;font-weight:700;color:var(--gold)}

    .app{
      max-width:980px;margin:22px auto;padding:16px;
    }

    header{
      display:flex;align-items:center;gap:12px;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .brand img{width:50px;height:50px;border-radius:8px;object-fit:cover}
    .brand h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}

    .btn{
      background:var(--primary);color:var(--white);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:var(--shadow)
    }
    .btn.outline{background:transparent;border:1px solid rgba(30,144,255,0.12);color:var(--primary);font-weight:600}

    .search-row{display:flex;gap:8px;margin-top:14px;align-items:center}
    input[type="search"]{flex:1;padding:10px 12px;border:1px solid #e3e7ee;border-radius:10px;background:#fff}

    .ads{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .card{
      background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--golden-shadow);display:flex;flex-direction:column;gap:6px;border:1px solid rgba(0,0,0,0.03)
    }
    .card .meta{display:flex;justify-content:space-between;align-items:center}
    .card h3{margin:0;font-size:16px}
    .card p{margin:0;color:var(--muted)}

    .card .actions{display:flex;gap:8px;margin-top:8px}
    .small-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}

    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:999;
    }
    .modal.open{display:flex}
    .modal .panel{width:100%;max-width:520px;background:var(--white);padding:16px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.18)}
    .modal input, .modal textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center}

    footer{margin-top:28px;text-align:center;color:var(--muted);font-size:13px;padding:12px 0}
    @media (max-width:600px){
      .app{padding:12px;margin:8px}
      header{flex-direction:column;align-items:stretch;gap:12px}
      .controls{justify-content:space-between}
    }
  </style>
</head>
<body>

  <div id="splash" aria-hidden="false">
    <img src="./assets/logo.png" alt="سوق الحي" />
    <div class="title">سوق الحي</div>
  </div>

  <div class="app" id="app" style="display:none">

    <header>
      <div class="brand">
        <img src="./assets/logo.png" alt="logo" />
        <div>
          <h1 id="site-title">سوق الحي</h1>
          <div style="color:var(--muted);font-size:12px" id="welcome-sub">منصة إعلانات الحي</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="add-ad-btn">+ إضافة إعلان</button>
        <button class="btn outline" id="lang-toggle">EN</button>
        <div id="auth-area"></div>
      </div>
    </header>

    <div class="search-row">
      <input type="search" id="search" placeholder="ابحث بالعنوان أو الوصف..." />
      <select id="sortBy" style="padding:10px;border-radius:8px;border:1px solid #e3e7ee;background:#fff">
        <option value="new">الأحدث</option>
        <option value="old">الأقدم</option>
      </select>
    </div>

    <div class="ads" id="ads-list" aria-live="polite"></div>

    <footer>© 2025 سوق الحي</footer>
  </div>

  <div class="modal" id="modal">
    <div class="panel" role="dialog" aria-modal="true">
      <h3 id="modal-title">إضافة إعلان</h3>
      <input id="ad-title" placeholder="عنوان الإعلان" />
      <textarea id="ad-desc" rows="5" placeholder="وصف الإعلان"></textarea>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn outline" id="cancel-btn">إلغاء</button>
        <button class="btn" id="save-btn">نشر</button>
      </div>
    </div>
  </div>

  <script>
  // ====== Firebase config: ضع مفاتيحك هنا ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
  };
  // ==========================================

  // تهيئة Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ترجمة رسمية إنجليزية
  const translations = {
    ar: {
      addAd: "+ إضافة إعلان",
      searchPlaceholder: "ابحث بالعنوان أو الوصف...",
      signIn: "تسجيل الدخول",
      signOut: "تسجيل الخروج",
      myAds: "إعلاناتي",
      publish: "نشر",
      cancel: "إلغاء",
      edit: "تعديل",
      del: "حذف",
      newest: "الأحدث",
      oldest: "الأقدم",
      welcomeSub: "منصة إعلانات الحي",
      modalAddTitle: "إضافة إعلان",
      modalEditTitle: "تعديل الإعلان",
    },
    en: {
      addAd: "+ Add Ad",
      searchPlaceholder: "Search by title or description...",
      signIn: "Sign in",
      signOut: "Sign out",
      myAds: "My Ads",
      publish: "Publish",
      cancel: "Cancel",
      edit: "Edit",
      del: "Delete",
      newest: "Newest",
      oldest: "Oldest",
      welcomeSub: "Neighborhood marketplace",
      modalAddTitle: "Add Ad",
      modalEditTitle: "Edit Ad",
    }
  };

  let lang = localStorage.getItem('nh_lang') || 'ar';
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

  function t(key){
    return translations[lang][key] || translations['en'][key] || key;
  }

  function updateTexts(){
    document.getElementById('add-ad-btn').textContent = t('addAd');
    document.getElementById('search').placeholder = t('searchPlaceholder');
    document.getElementById('sortBy').querySelector('option[value="new"]').textContent = t('newest');
    document.getElementById('sortBy').querySelector('option[value="old"]').textContent = t('oldest');
    document.getElementById('welcome-sub').textContent = t('welcomeSub');
    document.getElementById('modal-title').textContent = t('modalAddTitle');
    document.getElementById('lang-toggle').textContent = (lang === 'ar') ? 'EN' : 'ع';
  }

  // عناصر
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');
  const modal = document.getElementById('modal');
  const addAdBtn = document.getElementById('add-ad-btn');
  const saveBtn = document.getElementById('save-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const adTitleInput = document.getElementById('ad-title');
  const adDescInput = document.getElementById('ad-desc');
  const adsList = document.getElementById('ads-list');
  const authArea = document.getElementById('auth-area');
  const searchInput = document.getElementById('search');
  const sortBySelect = document.getElementById('sortBy');
  const langToggle = document.getElementById('lang-toggle');

  updateTexts();

  // شاشة التحميل 2 ثانية
  setTimeout(()=> {
    splash.classList.add('hidden');
    app.style.display = 'block';
    setTimeout(()=> splash.remove(), 600);
  }, 2000);

  let editingAdId = null;
  function openModal(editing=false, data={}){
    modal.classList.add('open');
    editingAdId = editing ? data.id : null;
    adTitleInput.value = editing ? data.title : '';
    adDescInput.value = editing ? data.description : '';
    document.getElementById('modal-title').textContent = editing ? t('modalEditTitle') : t('modalAddTitle');
  }
  function closeModal(){
    modal.classList.remove('open');
    editingAdId = null;
    adTitleInput.value = '';
    adDescInput.value = '';
  }
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  function renderAuthArea(user){
    authArea.innerHTML = '';
    if(user){
      const name = user.displayName || user.email.split('@')[0];
      const btn = document.createElement('div');
      btn.style.display='flex';btn.style.gap='8px';btn.style.alignItems='center';
      const span = document.createElement('span');
      span.textContent = name;
      span.style.color = 'var(--muted)';
      const outBtn = document.createElement('button');
      outBtn.className = 'btn outline';
      outBtn.textContent = t('signOut');
      outBtn.onclick = ()=> auth.signOut();
      btn.appendChild(span);
      btn.appendChild(outBtn);
      authArea.appendChild(btn);
    } else {
      const signBtn = document.createElement('button');
      signBtn.className = 'btn';
      signBtn.textContent = t('signIn');
      signBtn.onclick = showSignInPopup;
      authArea.appendChild(signBtn);
    }
  }

  function showSignInPopup(){
    const choice = confirm("Click OK to sign in with Google\nClick Cancel to sign in with Email");
    if(choice){
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err=> alert('Sign-in error: '+err.message));
    } else {
      const email = prompt("Enter your email:");
      if(!email) return;
      const pass = prompt("Enter a password (if account does not exist it will be created):");
      if(!pass) return;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err=>{
          if(err.code === 'auth/user-not-found'){
            auth.createUserWithEmailAndPassword(email, pass).catch(e=> alert('Error: '+e.message));
          } else alert('Error: '+err.message);
        });
    }
  }

  const adsCol = db.collection('ads');

  function timeAgo(ts){
    try{
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if(diff < 60) return diff + 's';
      if(diff < 3600) return Math.floor(diff/60) + 'm';
      if(diff < 86400) return Math.floor(diff/3600) + 'h';
      return d.toLocaleString();
    }catch(e){ return '-'; }
  }

  let adsSnapshotUnsub = null;
  function subscribeAds(order = 'desc'){
    if(adsSnapshotUnsub) adsSnapshotUnsub();
    adsList.innerHTML = '<div style="color:var(--muted)">Loading ads...</div>';
    adsSnapshotUnsub = adsCol.orderBy('createdAt', order === 'desc' ? 'desc' : 'asc')
      .onSnapshot(snapshot=>{
        const items = [];
        snapshot.forEach(doc=>{
          const data = doc.data();
          items.push({ id: doc.id, ...data });
        });
        renderAds(items);
      }, err=>{
        adsList.innerHTML = '<div style="color:red">Failed to load ads</div>';
        console.error(err);
      });
  }

  function renderAds(items){
    const q = searchInput.value.trim().toLowerCase();
    const filtered = items.filter(it=>{
      if(!q) return true;
      const t1 = (it.title||'').toLowerCase();
      const t2 = (it.description||'').toLowerCase();
      return t1.includes(q) || t2.includes(q);
    });

    if(filtered.length === 0) {
      adsList.innerHTML = '<div style="color:var(--muted)">' + (lang==='ar' ? 'لا توجد إعلانات حالياً' : 'No ads yet') + '</div>';
      return;
    }

    adsList.innerHTML = '';
    const user = auth.currentUser;
    filtered.forEach(item=>{
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('h3'); title.textContent = item.title || (lang==='ar' ? '(بدون عنوان)' : '(No title)');
      const desc = document.createElement('p'); desc.textContent = item.description || '';
      const metaRow = document.createElement('div'); metaRow.className='meta';
      const left = document.createElement('div');
      left.style.fontSize='13px';left.style.color='var(--muted)';
      left.textContent = `${item.ownerName || (lang==='ar' ? 'مستخدم' : 'User')} • ${timeAgo(item.createdAt)}`;
      const right = document.createElement('div');
      right.style.fontSize='12px';
      metaRow.appendChild(left);
      metaRow.appendChild(right);

      card.appendChild(metaRow);
      card.appendChild(title);
      card.appendChild(desc);

      if(user && item.ownerId === user.uid){
        const actions = document.createElement('div');
        actions.className = 'actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.textContent = t('edit');
        editBtn.onclick = ()=> openModal(true, { id: item.id, title: item.title, description: item.description });

        const delBtn = document.createElement('button');
        delBtn.className = 'small-btn';
        delBtn.textContent = t('del');
        delBtn.onclick = async ()=>{
          if(!confirm(lang==='ar' ? 'هل تريد حذف هذا الإعلان؟' : 'Delete this ad?')) return;
          try{
            await adsCol.doc(item.id).delete();
          }catch(e){ alert((lang==='ar' ? 'فشل الحذف: ' : 'Failed to delete: ') + e.message) }
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        card.appendChild(actions);
      }
      adsList.appendChild(card);
    });
  }

  saveBtn.addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user){ alert(lang==='ar' ? 'يجب تسجيل الدخول لنشر الإعلان' : 'You must sign in to post an ad'); return; }
    const title = adTitleInput.value.trim();
    const description = adDescInput.value.trim();
    if(!title || !description){ alert(lang==='ar' ? 'الرجاء ملء الحقول' : 'Please fill in the fields'); return; }

    saveBtn.disabled = true;
    try{
      if(editingAdId){
        await adsCol.doc(editingAdId).update({
          title, description, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await adsCol.add({
          title,
          description,
          ownerId: user.uid,
          ownerName: user.displayName || user.email.split('@')[0],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      closeModal();
    }catch(e){ alert((lang==='ar' ? 'خطأ: ' : 'Error: ') + e.message); }
    saveBtn.disabled = false;
  });

  auth.onAuthStateChanged(user=>{
    renderAuthArea(user);
  });

  subscribeAds('desc');

  sortBySelect.addEventListener('change', ()=> {
    const order = sortBySelect.value === 'new' ? 'desc' : 'asc';
    subscribeAds(order);
  });

  addAdBtn.addEventListener('click', ()=>{
    const user = auth.currentUser;
    if(!user){
      if(confirm(lang==='ar' ? 'يجب تسجيل الدخول لإضافة إعلان. تود تسجيل الدخول الآن؟' : 'You must sign in to add an ad. Sign in now?')){
        showSignInPopup();
      }
      return;
    }
    openModal(false);
  });

  let searchTimeout = null;
  searchInput.addEventListener('input', ()=>{
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(()=> {
      adsCol.orderBy('createdAt', sortBySelect.value==='new' ? 'desc' : 'asc').get().then(snap=>{
        const items = [];
        snap.forEach(doc=> items.push({id:doc.id, ...doc.data()}));
        renderAds(items);
      });
    }, 300);
  });

  langToggle.addEventListener('click', ()=>{
    lang = (lang === 'ar') ? 'en' : 'ar';
    localStorage.setItem('nh_lang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
    updateTexts();
  });

  </script>
</body>
</html>
